<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module controller
 * @description Catches user input and triggers {@link auth}, {@link model} and {@link module:view} functions accordingly.
 * @author xylnx
 * @see &lt;a href="https://github.com/xylnx">https://github.com/xylnx&lt;/a>
 */
const controller = (function () {
  /**
   * Contains html selectors, which are used to query elements.
   * @type {Object&lt;string, string>}
   * @memberof module:controller
   */
  const DOMStrings = {
    header: 'header',
    headerLower: '.header__lower',
    btnAdd: '.control__add',
    btnAddSvg: '.control__add svg',
    main: 'main',
    input: '.header__lower input',
    items: 'main',
    loginUser: '.login__input--user',
    loginPw: '.login__input--pw',
  };

  /**
   * Triggers a dialog modal asking the user to confirm deleting an item.
   * @param {string} itemName - The name of a list or an item
   * @memberof module:controller
   *
   */
  const confirmDelete = (itemName) => {
    return window.confirm(`Delete ${itemName}?`);
  };

  /**
   * Triggers {@link module:view.toggleInput}, which toggles the visibility of the input form.
   * @memberof module:controller
   */
  const handleAddBtn = () => {
    view.toggleInput(DOMStrings);
  };

  /**
   * Handles a form submit in the `overview view` and creates a new list if successful. It uses and triggers functions in {@link module:view} and {@link module:model}
   * @see {module:view.getElement} -- queries elements
   * @see {module:model.addList} -- adds a list to the data structure
   * @see {module:view.clearInputField} -- clears the input form
   * @see {module:view.renderLists} -- (re)renders the lists view
   * @memberof module:controller
   */
  const handleSubmit = () => {
    const input = view.getElement(DOMStrings.input);

    // Stop here, if the the form is empty
    if (!input.value) return;

    // Update model
    model.addList({ name: input.value });
    view.clearInputField(DOMStrings.input);

    // Render lists
    view.renderLists({ lists: model.getLists(), DOMString: DOMStrings.items });
  };

  /**
   * Handles a form submit in the `list view` which leads to the creation of a new item if successful. It uses and triggers functions in {@link module:view} and {@link module:model}
   * @see {module:model.getList} -- retrieves a list by ID
   * @see {module:view.getElement} -- queries elements
   * @see {module:model.item.add} -- adds an item to a list
   * @see {module:view.clearInputField} -- clears the input form
   * @see {module:view.renderLists} -- (re)renders the lists view
   * @see {module:view.toggleInput} -- toggles visibility of the input form
   * @memberof module:controller
   */
  const handleItemSubmit = () => {
    const list = model.getList(model.state.listID);
    const input = view.getElement(DOMStrings.input);
    if (!input.value) return;

    // Update model
    model.item.add({ name: input.value });
    view.clearInputField(DOMStrings.input);

    // Render items
    view.renderList({ list: list, DOMString: DOMStrings.items });

    // Open input again
    view.toggleInput(DOMStrings);
  };

  const handleLoginSubmit = async () => {
    const user = view.getElement(DOMStrings.loginUser).value;
    const pw = view.getElement(DOMStrings.loginPw).value;
    if (!user || !pw) return;

    model.state.update({ view: 'overview', user: user, password: pw });

    const loginResponse = await auth.login();
    if (!loginResponse) {
      model.state.update({ authToken: null, view: 'login' });
      loadLists();
    }
    model.state.update({ authToken: loginResponse.accessToken });
    await loadLists();
    view.renderLists({ lists: model.lists, DOMString: DOMStrings.items });
  };

  const handleTryOut = () => {
    const curLists = model.getLists();
    model.state.update({ view: 'overview' });
    view.renderLists({
      lists: curLists,
      DOMString: DOMStrings.main,
    });
    view.toggleInput(DOMStrings, document.querySelector('.controls__add'));
  };

  const handleListDelete = (target) => {
    const dataSet = target.parentNode.parentNode.dataset;
    const ID = dataSet.id;
    const name = dataSet.name;

    if (!confirmDelete(name)) return;

    model.removeList(ID);
    view.renderLists({ lists: model.getLists(), DOMString: DOMStrings.items });
  };

  const showList = (target) => {
    const id = target.dataset.id;
    const list = model.getList(id);
    view.renderList({ list: list, DOMString: DOMStrings.items });
    model.state.update({ view: 'list', listID: id });
  };

  const showOverview = () => {
    view.renderLists({ lists: model.getLists(), DOMString: DOMStrings.items });
    model.state.update({ view: 'overview', listID: null });
  };

  const changeItemStatus = (target) => {
    const itemID = target.parentNode.parentNode.dataset.id;
    model.state.update({ itemID: itemID });
    if (target.classList.contains('list-item__actions__status--do')) {
      model.item.statusUpdate({ itemID: itemID, isDone: true });
    }
    if (target.classList.contains('list-item__actions__status--done')) {
      model.item.statusUpdate({ itemID: itemID, isDone: false });
    }
    view.renderList({
      list: model.getList(model.state.listID),
      DOMString: DOMStrings.items,
    });
  };

  const dispatchEvents = (e) => {
    const events = {
      click: function () {
        if (e.target.classList.contains('control__add')) {
          handleAddBtn(e);
        }
        // LOGIN VIEW
        if (model.state.view === 'login') {
          if (e.target.classList.contains('login__submit')) {
            handleLoginSubmit();
          }
          if (e.target.classList.contains('login__try-me')) {
            handleTryOut();
          }
        }
        // LIST VIEW
        if (model.state.view === 'list') {
          if (e.target.classList.contains('list-item__actions__status')) {
            changeItemStatus(e.target);
          }
          if (e.target.classList.contains('input__submit')) {
            handleItemSubmit();
          }
          if (e.target.classList.contains('control__back-to-overview')) {
            showOverview();
          }
        }
        // LIST OVERVIEW
        if (model.state.view === 'overview') {
          if (e.target.classList.contains('input__submit')) {
            handleSubmit();
          }
          if (e.target.classList.contains('list__actions__delete')) {
            handleListDelete(e.target);
          }
          if (e.target.classList.contains('list')) {
            showList(e.target);
          }
        }
      },
      keydown: function () {
        const input = view.getElement(DOMStrings.input);
        if (model.state.view === 'login' &amp;&amp; e.key === 'Enter') {
          handleLoginSubmit();
        }
        if (
          model.state.view === 'list' &amp;&amp; //
          document.activeElement === input
        ) {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleItemSubmit();
          }
        }
        if (
          model.state.view === 'overview' &amp;&amp;
          document.activeElement === input
        ) {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleSubmit();
          }
        }
      },
    };
    return events[e.type]();
  };

  const listenToEvents = () => {
    const eventTypes = ['click', 'keydown'];
    eventTypes.map((eventType) =>
      document.body.addEventListener(eventType, dispatchEvents)
    );
  };

  const loadLists = async () => {
    try {
      await model.getLists({ API: true });
    } catch (error) {
      console.log('###', error.message);
      if (error.message === 'forbidden' || error.message === 'unauthorized') {
        console.log(1);

        try {
          await auth.refresh();
        } catch (error) {
          console.log('from init => try refresh:', error.message);
          if (error.message === 'refresh failed') {
            // Show login form
            model.state.update({ view: 'login' });
            view.renderLogin({ DOMString: DOMStrings.main });
          }
        }

        await model.getLists({ API: true });
        view.renderLists({ lists: model.lists, DOMString: DOMStrings.items });
        return;
      }
      if (error.message === 'no content') {
        console.log(555);
      } else {
        console.log(error.message);
        return;
      }
    }
  };

  const init = async () => {
    listenToEvents();
    const header = view.getElement(DOMStrings.header);
    const html = view.generateHtml(templates.header, {
      headingMain: 'hello world',
    });
    header.insertAdjacentHTML('beforeend', html);

    // Show login view
    // model.state.update({ view: 'login' });
    // view.renderLogin({ DOMString: DOMStrings.main });

    // testing();

    loadLists();

    view.renderLists({ lists: model.lists, DOMString: DOMStrings.items });
  };
  init();
})();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controller.html">controller</a></li><li><a href="module-view.html">view</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Fri Aug 12 2022 19:49:40 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
